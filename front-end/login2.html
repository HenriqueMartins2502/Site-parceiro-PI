<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Login PUCBets</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="base.css" rel="stylesheet" />
    <style>
        /* Estilos básicos para o pop-up, ajustar em base.css depois */
        .popup {
            display: none; /* Escondido por padrão */
            position: fixed; /* Fixa na tela */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5); /* Fundo semi-transparente */
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Garante que fique acima de outros elementos */
        }

        .popup-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-width: 90%;
            width: 300px; /* Ajustar a largura conforme necessário */
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

    </style>
  </head>
  
  <body class="bodyForms">
    <div class="top-rectangle">
      <buttonPUCBets type="button" class="buttonPUCBets" id="PUCBetsButton">PUCBets</button>
    </div>

    <div class="rectangleForms">
        <div class="d-grid gap-2 col-6 mx-auto">
            <p class="eggyolk" style="font-size: 45px; font-weight: bold;">LOGIN:</p>
            <button type="button" onclick="loginSuperID()">
                <span style="color: #A3B18A;">Super</span><span style="color: #586249;">ID</span>
              </button>          
            <button type="button" onclick="loginGoogle()">Google</button>
            <button type="button" onclick="loginFacebook()">Facebook</button>
        </div>
    </div>

    <div id="popup" class="popup">
        <div class="popup-content">
        <span class="close-btn" onclick="fecharPopup()">&times;</span>
        <p>Escaneie o QR Code com o app SuperID:</p>
        <img id="qrcode" src="" alt="QR Code" style="width: 200px;">
        <p id="statusMessage" style="margin-top: 15px; font-weight: bold;"></p>
        </div>
    </div>
  

    <script>
        // URLs das minhas funções Firebase
        const PERFORM_AUTH_FUNCTION_URL = "https://performauth-doos7adaja-uc.a.run.app";
        const GET_LOGIN_STATUS_FUNCTION_URL = "https://us-central1-superid-66b3d.cloudfunctions.net/getLoginStatus"; // Nova URL!

        // Credenciais do parceiro (Document ID da coleção 'partners' e a API Key)
        const PARTNER_SITE_ID = "127.0.0.1:5501"; 
        const API_KEY = "123456789"; // chave real

        let loginStatusTimeout; // Variável para armazenar o ID do timeout para o próximo polling
        let currentLoginTokenId = null; // Variável para armazenar o loginTokenId atual
        let pollingAttempts = 0; // Contador de tentativas de polling
        const MAX_POLLING_ATTEMPTS = 3; // Limite de 3 tentativas
        const POLLING_INTERVAL_MS = 60000; // Intervalo de 1 minuto (60 segundos)

        async function loginSuperID() {
            // Limpa qualquer polling anterior para evitar múltiplos intervalos
            if (loginStatusTimeout) {
                clearTimeout(loginStatusTimeout);
            }
            pollingAttempts = 0; // Reseta o contador de tentativas
            
            // Limpa a mensagem de status e a imagem do QR Code
            document.getElementById("qrcode").src = "";
            document.getElementById("statusMessage").textContent = "Gerando QR Code...";
            document.getElementById("popup").style.display = "flex"; // Mostra o pop-up imediatamente

            try {
                const response = await fetch(PERFORM_AUTH_FUNCTION_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        partnerSite: PARTNER_SITE_ID,
                        apiKey: API_KEY,
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    console.log("QR Code gerado com sucesso:", data.qrCodeBase64);
                    console.log("Login Token ID:", data.loginTokenId);
                    
                    currentLoginTokenId = data.loginTokenId; // Armazena o ID do token

                    // Exibe o QR Code no pop-up
                    document.getElementById("qrcode").src = `data:image/png;base64,${data.qrCodeBase64}`;
                    document.getElementById("statusMessage").textContent = "Escaneie o QR Code com o app SuperID:";

                    // Inicia o polling para verificar status de login 
                    // Chama a primeira verificação imediatamente
                    checkLoginStatus(); 

                } else {
                    console.error("Erro ao gerar QR Code:", data.error || "Erro desconhecido.");
                    document.getElementById("statusMessage").textContent = "Erro ao gerar QR Code.";
                    alert("Erro ao gerar QR Code: " + (data.error || "Erro desconhecido."));
                    fecharPopup(); // Fecha o pop-up em caso de erro
                }
            } catch (error) {
                console.error("Erro na requisição ou no servidor:", error);
                document.getElementById("statusMessage").textContent = "Erro de comunicação.";
                alert("Erro na comunicação com o servidor. Verifique o console.");
                fecharPopup(); // Fecha o pop-up em caso de erro
            }
        }

        // NOVA FUNÇÃO: Verifica o status do login no Firebase
        async function checkLoginStatus() {
            if (!currentLoginTokenId) {
                console.warn("Nenhum loginTokenId disponível para verificar o status.");
                return; // Sai da função
            }

            pollingAttempts++; // Incrementa o contador de tentativas

            if (pollingAttempts > MAX_POLLING_ATTEMPTS) {
                console.log("Número máximo de tentativas de polling atingido. Login não aprovado.");
                document.getElementById("statusMessage").textContent = "Tempo esgotado para login. Tente novamente.";
                fecharPopup(); // Fecha o pop-up
                return; // Sai da função
            }

            console.log(`Verificando status do login (tentativa ${pollingAttempts} de ${MAX_POLLING_ATTEMPTS})...`);
            document.getElementById("statusMessage").textContent = `Aguardando escaneamento e aprovação... (Tentativa ${pollingAttempts}/${MAX_POLLING_ATTEMPTS})`;

            try {
                const response = await fetch(GET_LOGIN_STATUS_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ loginTokenId: currentLoginTokenId })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.status === "approved") {
                        console.log("Login Aprovado!", data.user);
                        document.getElementById("statusMessage").textContent = `Login Aprovado! Bem-vindo(a), ${data.user || 'usuário(a)'}!`;
                        clearTimeout(loginStatusTimeout); // Para o polling

                        // Redireciona para a página de sucesso após um pequeno atraso
                        setTimeout(() => {
                            window.location.href = "paginaSucesso.html"; // Redireciona para a sua página de sucesso
                        }, 1500); 

                    } else if (data.status === "pending") {
                        console.log("Login Pendente. Agendando próxima verificação...");
                        // Agenda a próxima verificação apenas se ainda não aprovado e dentro do limite
                        loginStatusTimeout = setTimeout(checkLoginStatus, POLLING_INTERVAL_MS); 
                    } else {
                        console.warn("Status de login desconhecido:", data.status);
                        document.getElementById("statusMessage").textContent = "Status desconhecido. Fechando.";
                        clearTimeout(loginStatusTimeout); // Para o polling
                        fecharPopup(); // Fecha o pop-up
                    }
                } else {
                    console.error("Erro ao verificar status de login:", data.error || "Erro desconhecido.");
                    document.getElementById("statusMessage").textContent = "Erro ao verificar status. Fechando.";
                    clearTimeout(loginStatusTimeout); // Para o polling
                    alert("Erro ao verificar status de login: " + (data.error || "Erro desconhecido."));
                    fecharPopup(); // Fecha o pop-up em caso de erro
                }

            } catch (error) {
                console.error("Erro na requisição de status:", error);
                document.getElementById("statusMessage").textContent = "Erro de rede no status. Fechando.";
                clearTimeout(loginStatusTimeout); // Para o polling
                alert("Erro de rede ao verificar status: " + error.message);
                fecharPopup(); // Fecha o pop-up em caso de erro
            }
        }

        function fecharPopup() {
            document.getElementById("popup").style.display = "none";
            document.getElementById("qrcode").src = ""; // Limpa a imagem do QR Code
            document.getElementById("statusMessage").textContent = ""; // Limpa a mensagem
            clearTimeout(loginStatusTimeout); // Garante que o polling pare ao fechar o pop-up
            currentLoginTokenId = null; // Reseta o ID do token
            pollingAttempts = 0; // Reseta o contador de tentativas
        }

        function loginGoogle() {
            alert("Login com Google ainda não implementado.");
        }

        function loginFacebook() {
            alert("Login com Facebook ainda não implementado.");
        }

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  </body>
</html>